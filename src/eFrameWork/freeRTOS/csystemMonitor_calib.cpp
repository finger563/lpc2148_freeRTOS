

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// FILE NAME:     $Source:$
//                $Date:$
//                $Revision:$
//
// AUTHOR:        Jean-Sebastien Stoezel (js.stoezel@gmail.com)
//
// HISTORY:       $Log:$
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
#include "CSystemMonitor.hpp"
#include "CLog.hpp"
#include "FreeRTOS.h"
#include "task.h"
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CSystemMonitor::CSystemMonitor():
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   m_CpuLoadCnt(0),
   m_CpuLoadRef(100)
{} // CSystemMonitor::CSystemMonitor

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CSystemMonitor::~CSystemMonitor()
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
{} // CSystemMonitor::~CSystemMonitor

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
CSystemMonitor::CSystemMonitor(
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
   const uint32_t rate,
   char *         p_Name,
   const uint32_t stackSize,
   const uint32_t priority
   )
{
   m_Rate			= rate;
   mp_Name			= p_Name;
   m_StackSize		= stackSize;
   m_Priority		= priority;
} // CSystemMonitor::CSystemMonitor

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
int32_t CSystemMonitor::Init(void)
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
{
   int32_t     result = -1;

   LOG_TRACE("CSystemMonitor::Init");
   
   m_CpuLoadMutex = xSemaphoreCreateMutex();
   
   if(0 != m_CpuLoadMutex)
   {
      LOG_INFO("CSystemMonitor::Init m_CpuLoadMutex valid");
   }
   else
   {
      LOG_ERROR("CSystemMonitor::Init m_CpuLoadMutex");
   }
   
   // Create the CPu load task
   if(
    pdPASS == (xTaskCreate(CSystemMonitor::CpuLoadTask, reinterpret_cast<signed char const * const>("cpu_load"), 2*1024, this, 0, NULL)))
   {
      LOG_DEBUG("CSystemMonitor::Init xTaskCreate succeeded");
      result = 0;
   }
   else
   {
      LOG_WARNING("CSystemMonitor::Init xTaskCreate failed with code");
      result = -1;
   }
   
   result = CSubsystem::Init();

   return result;
} // CSystemMonitor::Init

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSystemMonitor::CpuLoadGet(
   uint8_t &    cpuLoad,
   uint32_t &  cpuCnt
)
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
{
   cpuLoad = CpuLoadGet();
   cpuCnt = m_CpuLoadRef;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
uint8_t CSystemMonitor::CpuLoadGet(void)
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
{
   uint8_t	result = 0;
   
   xSemaphoreTake(m_CpuLoadMutex, portMAX_DELAY);
   
   // Auto-calibration
   if(m_CpuLoadCnt > m_CpuLoadRef)
   {
      m_CpuLoadRef = m_CpuLoadCnt;
   }
   else
   {}
   
   if(0 == m_CpuLoadRef)
   {
      result = 100;
   }
   else
   {
      result = 100 - static_cast<uint8_t>((m_CpuLoadCnt * 100) / m_CpuLoadRef);
   }
   
   m_CpuLoadCnt = 0;
   
   xSemaphoreGive(m_CpuLoadMutex);
   
   return result;
   
} // CpuLoadGet

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSystemMonitor::CpuLoadTask( void *pvParameters )
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
{
   reinterpret_cast<CSystemMonitor *>(pvParameters)->CpuLoadTask();
} // CSystemMonitor::CpuLoadTask

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSystemMonitor::PeriodicHandler(void)
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
{
   uint8_t  cpuLoad  = 0;
   uint32_t cpuRef   = 0;
   
   CpuLoadGet(cpuLoad, cpuRef);
   LOG("\rCSystemMonitor::Task cpu_ref=%06u", cpuRef);
} // CSystemMonitor::PeriodicHandler

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void CSystemMonitor::CpuLoadTask(void)
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
{

   while(true)
   {
      xSemaphoreTake(m_CpuLoadMutex, portMAX_DELAY);
      m_CpuLoadCnt++;
      xSemaphoreGive(m_CpuLoadMutex);
   } // for(;;)
} // CSystemMonitor::CpuLoadTask
